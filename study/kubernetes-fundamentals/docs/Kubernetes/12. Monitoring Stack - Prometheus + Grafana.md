# Kubernetes Monitoring Stack (Prometheus & Grafana)

## ðŸŽ¯ What is the kube-prometheus-stack?

**kube-prometheus-stack** is a comprehensive monitoring solution for Kubernetes that bundles together:
- **Prometheus** - Metrics collection and storage
- **Grafana** - Visualization and dashboards
- **Alertmanager** - Alert handling and routing
- **Node Exporter** - Host-level metrics
- **Kube State Metrics** - Kubernetes object metrics
- **Prometheus Operator** - Simplifies deployment and configuration

### Why Use This Stack?
- **Complete solution** - Everything you need for Kubernetes monitoring
- **Pre-configured dashboards** - Ready-to-use Grafana dashboards
- **Production-ready** - Battle-tested configurations
- **Extensible** - Easy to add custom metrics and alerts
- **Cloud-native** - Built specifically for Kubernetes

---

## ðŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Kubernetes Cluster                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    Node 1    â”‚    â”‚    Node 2    â”‚    â”‚    Node 3    â”‚      â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚      â”‚
â”‚  â”‚ Node Exporterâ”‚    â”‚ Node Exporterâ”‚    â”‚ Node Exporterâ”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                   â”‚                   â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                             â”‚                                   â”‚
â”‚                             â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚              Prometheus Server              â”‚               â”‚
â”‚  â”‚  - Scrapes metrics from all sources         â”‚               â”‚
â”‚  â”‚  - Stores time-series data                  â”‚               â”‚
â”‚  â”‚  - Evaluates alerting rules                 â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                        â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â–¼              â–¼              â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Grafana  â”‚  â”‚Alertmanagerâ”‚ â”‚Kube State     â”‚              â”‚
â”‚  â”‚           â”‚  â”‚            â”‚  â”‚Metrics        â”‚              â”‚
â”‚  â”‚ Dashboardsâ”‚  â”‚ Alerts     â”‚  â”‚               â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚           Prometheus Operator               â”‚               â”‚
â”‚  â”‚  - Manages Prometheus instances             â”‚               â”‚
â”‚  â”‚  - Enables CRDs (Custom Resource Defs)      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“¦ Stack Components Explained

### 1. Prometheus Server
```
prometheus-prometheus-stack-kube-prom-prometheus-0
```
- **Purpose**: Collects and stores metrics
- **Function**: Scrapes metrics from configured targets
- **Storage**: Time-series database (TSDB)
- **Queries**: Uses PromQL query language

### 2. Alertmanager
```
alertmanager-prometheus-stack-kube-prom-alertmanager-0
```
- **Purpose**: Handles alerts from Prometheus
- **Function**: Routes, groups, and sends notifications
- **Integrations**: Email, Slack, PagerDuty, webhooks
- **Features**: Silencing, inhibition, grouping

### 3. Grafana
```
prometheus-stack-grafana-7f854d64f-vzxpl
```
- **Purpose**: Visualization and dashboards
- **Function**: Queries Prometheus, displays metrics
- **Features**: Pre-built dashboards, custom dashboards
- **Default Login**: admin / admin (or from values file)

### 4. Prometheus Operator
```
prometheus-stack-kube-prom-operator-6d7747d746-7852f
```
- **Purpose**: Simplifies Prometheus deployment on Kubernetes
- **Function**: Manages Prometheus, Alertmanager instances
- **CRDs**: ServiceMonitor, PodMonitor, PrometheusRule
- **Benefit**: Declarative monitoring configuration

### 5. Kube State Metrics
```
prometheus-stack-kube-state-metrics-589c95b8f6-hlkd6
```
- **Purpose**: Exposes Kubernetes object metrics
- **Function**: Listens to Kubernetes API server
- **Metrics**: Deployments, Pods, Nodes, Services, etc.
- **Examples**: Pod status, replica counts, resource requests

### 6. Node Exporter
```
prometheus-stack-prometheus-node-exporter-gntdn
```
- **Purpose**: Collects host-level metrics
- **Function**: Runs as DaemonSet on every node
- **Metrics**: CPU, memory, disk, network, filesystem
- **Deployment**: One per node (DaemonSet)

---

## ðŸš€ Installation

### Add Helm Repository
```bash
helm repo add kube-prometheus-stack https://prometheus-community.github.io/helm-charts
helm repo update
```

### Basic Installation
```bash
helm install prometheus-stack kube-prometheus-stack/kube-prometheus-stack \
  --namespace=monitoring \
  --create-namespace
```

### Installation Output
```
NAME: prometheus-stack
LAST DEPLOYED: Thu Jan  8 19:19:37 2026
NAMESPACE: monitoring
STATUS: deployed
REVISION: 1
```

### Verify Installation
```bash
# Check all pods in monitoring namespace
kubectl --namespace monitoring get pods -l "release=prometheus-stack"

# Check all resources
kubectl get all -n monitoring
```

### Expected Pods
```
NAME                                                     READY   STATUS    RESTARTS   AGE
alertmanager-prometheus-stack-kube-prom-alertmanager-0   2/2     Running   0          3d19h
prometheus-prometheus-stack-kube-prom-prometheus-0       2/2     Running   0          3d19h
prometheus-stack-grafana-7f854d64f-vzxpl                 3/3     Running   0          3d19h
prometheus-stack-kube-prom-operator-6d7747d746-7852f     1/1     Running   0          3d19h
prometheus-stack-kube-state-metrics-589c95b8f6-hlkd6     1/1     Running   0          3d19h
prometheus-stack-prometheus-node-exporter-gntdn          1/1     Running   0          3d19h
```

---

## ðŸ”‘ Accessing Grafana

### Method 1: Port Forward (Quick Access)
```bash
# Get Grafana pod name
export POD_NAME=$(kubectl --namespace monitoring get pod \
  -l "app.kubernetes.io/name=grafana,app.kubernetes.io/instance=prometheus-stack" -oname)

# Port forward to local machine
kubectl --namespace monitoring port-forward $POD_NAME 3000

# Access at http://localhost:3000
```

### Method 2: LoadBalancer Service (Production)
Create a LoadBalancer service for external access:

```yaml
# loadbalancer.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: grafana
  name: grafana-loadbalancer
  namespace: monitoring
spec:
  ports:
  - port: 3000
    protocol: TCP
    targetPort: 3000
  selector:
    app.kubernetes.io/instance: prometheus-stack
    app.kubernetes.io/name: grafana
  type: LoadBalancer
```

```bash
kubectl apply -f loadbalancer.yaml

# Check service
kubectl get svc -n monitoring grafana-loadbalancer
```

### Get Admin Password

#### From Kubernetes Secret
```bash
kubectl --namespace monitoring get secrets prometheus-stack-grafana \
  -o jsonpath="{.data.admin-password}" | base64 -d ; echo
```

#### Alternative Method
```bash
kubectl get secret --namespace monitoring \
  -l app.kubernetes.io/component=admin-secret \
  -o jsonpath="{.items[0].data.admin-password}" | base64 --decode ; echo
```

### Default Credentials
- **Username**: admin
- **Password**: prom-operator (default) or check values.yaml

---

## âš™ï¸ Configuration with Values Files

### Export Default Values
```bash
mkdir monitoring
cd monitoring

# Export all default values for reference
helm show values kube-prometheus-stack/kube-prometheus-stack > prometheus-default-values.yaml
```

### Custom Values File
```yaml
# values.yaml
grafana:
  adminPassword: hello-world
  
  # Enable persistence for Grafana
  persistence:
    enabled: true
    size: 1Gi
  
  # Configure service type
  service:
    type: LoadBalancer

prometheus:
  prometheusSpec:
    # Retention period for metrics
    retention: 15d
    
    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi

alertmanager:
  alertmanagerSpec:
    # Retention for alerts
    retention: 120h
```

### Install with Custom Values
```bash
helm install prometheus-stack kube-prometheus-stack/kube-prometheus-stack \
  --namespace=monitoring \
  --create-namespace \
  --values=values.yaml
```

### Upgrade Existing Installation
```bash
helm upgrade prometheus-stack kube-prometheus-stack/kube-prometheus-stack \
  --namespace=monitoring \
  --values=values.yaml
```

---

## ðŸ“Š Understanding Metrics

### Time Series Data
- **Metrics are stored with timestamps** - Enables historical analysis
- **Format**: `metric_name{label1="value1", label2="value2"} value timestamp`
- **Visualization**: Plot development of metrics over time

### Metric Types
| Type | Description | Example |
|------|-------------|---------|
| **Counter** | Only increases | `http_requests_total` |
| **Gauge** | Can go up/down | `memory_usage_bytes` |
| **Histogram** | Distribution of values | `request_duration_seconds` |
| **Summary** | Pre-calculated quantiles | `request_latency` |

### Common Kubernetes Metrics

#### From Kube State Metrics
```promql
# Pod status
kube_pod_status_phase{phase="Running"}

# Deployment replicas
kube_deployment_spec_replicas
kube_deployment_status_replicas_available

# Node status
kube_node_status_condition{condition="Ready"}
```

#### From Node Exporter
```promql
# CPU usage
node_cpu_seconds_total

# Memory usage
node_memory_MemAvailable_bytes

# Disk usage
node_filesystem_avail_bytes
```

---

## ðŸ“ˆ Grafana Dashboards

### Pre-installed Dashboards
The kube-prometheus-stack includes many pre-configured dashboards:
- **Kubernetes / Compute Resources / Cluster**
- **Kubernetes / Compute Resources / Namespace (Pods)**
- **Kubernetes / Compute Resources / Node (Pods)**
- **Kubernetes / Networking / Cluster**
- **Node Exporter / Nodes**
- **Prometheus / Overview**

### Accessing Dashboards
1. Login to Grafana (http://localhost:3000 or LoadBalancer IP)
2. Navigate to **Dashboards** â†’ **Browse**
3. Select a dashboard from the list

### Creating Custom Dashboards
1. Click **+** â†’ **Dashboard**
2. Add panels with PromQL queries
3. Configure visualization options
4. Save dashboard

---

## ðŸ”” Alerting

### Alertmanager Configuration
```yaml
# In values.yaml
alertmanager:
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'default-receiver'
    receivers:
    - name: 'default-receiver'
      slack_configs:
      - api_url: 'https://hooks.slack.com/services/xxx'
        channel: '#alerts'
```

### Creating Alert Rules
```yaml
# Custom PrometheusRule
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: custom-alerts
  namespace: monitoring
spec:
  groups:
  - name: custom.rules
    rules:
    - alert: HighMemoryUsage
      expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High memory usage on {{ $labels.instance }}"
        description: "Memory usage is above 90%"
```

---

## ðŸ› ï¸ Common Operations

### Port Forward Services
```bash
# Grafana
kubectl port-forward svc/prometheus-stack-grafana 3000:80 -n monitoring

# Prometheus
kubectl port-forward svc/prometheus-stack-kube-prom-prometheus 9090:9090 -n monitoring

# Alertmanager
kubectl port-forward svc/prometheus-stack-kube-prom-alertmanager 9093:9093 -n monitoring
```

### Check Prometheus Targets
```bash
# Port forward to Prometheus
kubectl port-forward svc/prometheus-stack-kube-prom-prometheus 9090:9090 -n monitoring

# Access http://localhost:9090/targets
```

### View Alertmanager
```bash
# Port forward to Alertmanager
kubectl port-forward svc/prometheus-stack-kube-prom-alertmanager 9093:9093 -n monitoring

# Access http://localhost:9093
```

### Check Helm Release
```bash
helm ls -n monitoring
helm status prometheus-stack -n monitoring
helm history prometheus-stack -n monitoring
```

---

## ðŸ“‚ Project Structure Example

```
kubernetes-fundamentals/
â”œâ”€â”€ monitoring/
â”‚   â”œâ”€â”€ prometheus-default-values.yaml  # Reference (exported)
â”‚   â”œâ”€â”€ values.yaml                     # Custom overrides
â”‚   â””â”€â”€ loadbalancer.yaml               # Grafana LoadBalancer service
â”œâ”€â”€ mealie/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ storage.yaml
â””â”€â”€ ...
```

---

## ðŸŽ¯ Best Practices

### Installation
- **Always export default values** - Reference for available options
- **Use values files** - Version control your configuration
- **Start minimal** - Add customizations incrementally
- **Use namespaces** - Isolate monitoring stack

### Production Configuration
```yaml
# production-values.yaml
prometheus:
  prometheusSpec:
    retention: 30d
    resources:
      requests:
        memory: 2Gi
        cpu: 500m
      limits:
        memory: 4Gi
        cpu: 1000m
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: fast-ssd
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi

grafana:
  persistence:
    enabled: true
    size: 10Gi
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 200m
  
  # Configure external access
  ingress:
    enabled: true
    hosts:
      - grafana.example.com
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.example.com
```

### Security
- **Change default passwords** - Never use admin/admin in production
- **Use secrets** - Store sensitive values in Kubernetes secrets
- **Enable authentication** - Configure proper user management
- **Network policies** - Restrict access to monitoring components
- **TLS** - Enable HTTPS for Grafana access

### Monitoring Your Monitoring
- Set up alerts for Prometheus health
- Monitor disk usage for time-series storage
- Alert on scrape failures
- Dashboard for monitoring stack health

---

## ðŸ“‹ Quick Commands Reference

```bash
# Installation
helm repo add kube-prometheus-stack https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus-stack kube-prometheus-stack/kube-prometheus-stack -n monitoring --create-namespace

# Values Management
helm show values kube-prometheus-stack/kube-prometheus-stack > default-values.yaml
helm upgrade prometheus-stack kube-prometheus-stack/kube-prometheus-stack -n monitoring -f values.yaml

# Access Services
kubectl port-forward svc/prometheus-stack-grafana 3000:80 -n monitoring
kubectl port-forward svc/prometheus-stack-kube-prom-prometheus 9090:9090 -n monitoring
kubectl port-forward svc/prometheus-stack-kube-prom-alertmanager 9093:9093 -n monitoring

# Get Grafana Password
kubectl get secret prometheus-stack-grafana -n monitoring -o jsonpath="{.data.admin-password}" | base64 -d

# Check Status
kubectl get pods -n monitoring
kubectl get svc -n monitoring
helm ls -n monitoring

# Uninstall
helm uninstall prometheus-stack -n monitoring
```
