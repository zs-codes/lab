## ðŸŽ¯ What is Helm?

**Helm** is the package manager for Kubernetes. It allows you to define, install, and upgrade complex Kubernetes applications using **Charts**.

### Key Concepts
- **Chart** - A complete package of Kubernetes resources (like a .deb or .rpm for Linux)
- **Release** - An instance of a chart running in a Kubernetes cluster
- **Repository** - A place where charts are stored and shared
- **Values** - Configuration that customizes chart behavior

### Why Use Helm?
- **Simplifies deployment** - One command instead of multiple kubectl applies
- **Manages dependencies** - Charts can depend on other charts
- **Version control** - Easy rollback and upgrade
- **Reusability** - Share and reuse configurations
- **Templating** - Dynamic values with Go templates

---

## ðŸ“ Helm Chart Structure

```
mychart/
â”œâ”€â”€ Chart.yaml          # Chart metadata (name, version, description)
â”œâ”€â”€ values.yaml         # Default configuration values
â”œâ”€â”€ charts/             # Dependencies (sub-charts)
â”œâ”€â”€ templates/          # Kubernetes manifest templates
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”œâ”€â”€ _helpers.tpl    # Template helpers
â”‚   â””â”€â”€ NOTES.txt       # Post-install notes
â””â”€â”€ .helmignore         # Files to ignore when packaging
```

### Chart.yaml
```yaml
apiVersion: v2
name: mealie
description: A Helm chart for Mealie recipe manager
type: application
version: 1.0.0        # Chart version
appVersion: "v3.3.2"  # Application version
```

### values.yaml
```yaml
# Default values - can be overridden at install time
replicaCount: 1

image:
  repository: ghcr.io/mealie-recipes/mealie
  tag: "v3.3.2"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 9000

persistence:
  enabled: true
  size: 500Mi
```

### templates/deployment.yaml
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: mealie
  name: mealie
  namespace: mealie
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: mealie
  template:
    metadata:
      labels:
        app: mealie
    spec:
      containers:
      - image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        name: mealie
        ports:
          - containerPort: {{ .Values.service.port }}
        volumeMounts:
          - mountPath: "/app/data"
            name: mealie-data
      volumes:
        - name: mealie-data
          persistentVolumeClaim:
            claimName: mealie-data
```

---

## ðŸš€ Essential Helm Commands

### Repository Management
```bash
# Add a Helm repository
helm repo add homarr-labs https://homarr-labs.github.io/charts/

# Update repository cache
helm repo update

# List configured repositories
helm repo list

# Remove a repository
helm repo remove homarr-labs

# Search for charts in repositories
helm search repo homarr
```

### Installing Charts
```bash
# Basic install (installs in default namespace)
helm install homarr homarr-labs/homarr

# Install in specific namespace (create if not exists)
helm install homarr homarr-labs/homarr --namespace homarr --create-namespace

# Install with custom values file
helm install homarr homarr-labs/homarr --namespace homarr --create-namespace --values=values.yaml

# Install with inline value overrides
helm install homarr homarr-labs/homarr --set replicaCount=3

# Dry run (test without installing)
helm install homarr homarr-labs/homarr --dry-run

# Generate manifests only (no install)
helm template homarr homarr-labs/homarr
```

### Managing Releases
```bash
# List installed releases in current namespace
helm ls

# List releases in all namespaces
helm ls -A

# List releases in specific namespace
helm ls -n homarr

# Get release status
helm status homarr -n homarr

# Get release history
helm history homarr -n homarr
```

### Upgrading and Rollback
```bash
# Upgrade release with new values
helm upgrade homarr homarr-labs/homarr -n homarr --values=values.yaml

# Upgrade or install if not exists
helm upgrade --install homarr homarr-labs/homarr -n homarr --create-namespace

# Rollback to previous revision
helm rollback homarr -n homarr

# Rollback to specific revision
helm rollback homarr 2 -n homarr
```

### Uninstalling
```bash
# Uninstall a release
helm uninstall homarr -n homarr

# Uninstall but keep history
helm uninstall homarr -n homarr --keep-history
```

### Inspecting Charts
```bash
# Show chart information
helm show chart homarr-labs/homarr

# Show default values (very useful!)
helm show values homarr-labs/homarr

# Show all chart info
helm show all homarr-labs/homarr

# Show README
helm show readme homarr-labs/homarr
```

---

## ðŸ“ Working with Values

### Values Priority (lowest to highest)
1. Default values in `values.yaml`
2. Parent chart's values
3. Values file passed with `-f` or `--values`
4. Individual values with `--set`

### Custom Values File
```yaml
# my-values.yaml
replicaCount: 2

image:
  tag: "v1.50.0"

service:
  type: LoadBalancer

persistence:
  homarrDatabase:
    enabled: true
    size: "100Mi"

ingress:
  enabled: true
  hosts:
    - host: homarr.example.com
      paths:
        - path: /
```

### Installing with Custom Values
```bash
# Single values file
helm install homarr homarr-labs/homarr -f my-values.yaml

# Multiple values files (later files override earlier)
helm install homarr homarr-labs/homarr -f values.yaml -f production.yaml

# Combining values file with --set
helm install homarr homarr-labs/homarr -f values.yaml --set replicaCount=5
```

### Using --set for Individual Values
```bash
# Simple value
helm install homarr homarr-labs/homarr --set replicaCount=3

# Nested value
helm install homarr homarr-labs/homarr --set image.tag="v1.50.0"

# Multiple values
helm install homarr homarr-labs/homarr --set replicaCount=3,service.type=LoadBalancer

# Array values
helm install homarr homarr-labs/homarr --set 'ingress.hosts[0].host=homarr.local'
```

---

## ðŸ”§ Creating Your Own Charts

### Convert Existing YAMLs to Helm Chart

#### Current Project Structure
```
kubernetes-fundamentals/
â”œâ”€â”€ mealie/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ storage.yaml
```

#### Create Chart Structure
```bash
# Create new chart
helm create mealie-chart

# Or manually create structure
mkdir -p mealie-chart/templates
```

#### Chart Structure After Conversion
```
mealie-chart/
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ values.yaml
â””â”€â”€ templates/
    â”œâ”€â”€ namespace.yaml
    â”œâ”€â”€ deployment.yaml
    â”œâ”€â”€ service.yaml
    â””â”€â”€ storage.yaml
```

### Example: Templated Deployment
**Before (static):**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: mealie
  name: mealie
  namespace: mealie
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mealie
  template:
    metadata:
      labels:
        app: mealie
    spec:
      containers:
      - image: ghcr.io/mealie-recipes/mealie:v3.3.2
        name: mealie
        ports:
          - containerPort: 9000
        volumeMounts:
          - mountPath: "/app/data"
            name: mealie-data
      volumes:
        - name: mealie-data
          persistentVolumeClaim:
            claimName: mealie-data
```

**After (templated):**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: {{ .Chart.Name }}
  name: {{ .Chart.Name }}
  namespace: {{ .Values.namespace }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ .Chart.Name }}
  template:
    metadata:
      labels:
        app: {{ .Chart.Name }}
    spec:
      containers:
      - image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        name: {{ .Chart.Name }}
        ports:
          - containerPort: {{ .Values.service.port }}
        volumeMounts:
          - mountPath: {{ .Values.persistence.mountPath }}
            name: {{ .Chart.Name }}-data
      volumes:
        - name: {{ .Chart.Name }}-data
          persistentVolumeClaim:
            claimName: {{ .Chart.Name }}-data
```

**values.yaml:**
```yaml
namespace: mealie
replicaCount: 1

image:
  repository: ghcr.io/mealie-recipes/mealie
  tag: "v3.3.2"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 9000

persistence:
  enabled: true
  mountPath: "/app/data"
  size: 500Mi
  storageClass: local-path
  accessMode: ReadWriteOnce
```

---

## ðŸŽ¨ Go Templating Basics

### Common Template Functions
```yaml
# Default value if not set
replicas: {{ .Values.replicaCount | default 1 }}

# Quote strings
name: {{ .Values.name | quote }}

# Conditional
{{- if .Values.ingress.enabled }}
# ingress configuration here
{{- end }}

# Loop
{{- range .Values.hosts }}
- host: {{ . }}
{{- end }}

# Include template
{{ include "mychart.fullname" . }}

# Required value (fail if not set)
password: {{ required "Password is required" .Values.password }}
```

### Built-in Objects
```yaml
{{ .Chart.Name }}        # Chart name
{{ .Chart.Version }}     # Chart version
{{ .Chart.AppVersion }}  # App version
{{ .Release.Name }}      # Release name
{{ .Release.Namespace }} # Release namespace
{{ .Values.key }}        # Values from values.yaml
{{ .Files }}             # Access to files
{{ .Capabilities }}      # Kubernetes capabilities
```

### Whitespace Control
```yaml
# Remove leading whitespace
{{- .Values.name }}

# Remove trailing whitespace
{{ .Values.name -}}

# Remove both
{{- .Values.name -}}
```

---

## ðŸ“Š Real-World Example: Homarr Values

```yaml
# Key configuration sections from homarr values.yaml

# -- Number of replicas
replicaCount: 1

# -- Deployment strategy (important for PVC access modes)
strategyType: RollingUpdate

image:
  repository: ghcr.io/homarr-labs/homarr
  pullPolicy: IfNotPresent
  tag: "v1.49.1"

env:
  TZ: "Europe/Paris"
  LOG_LEVEL: "info"
  AUTH_PROVIDERS: "credentials"
  AUTH_SESSION_EXPIRY_TIME: "30d"

database:
  type: sqlite
  migrationEnabled: true

# Secrets management (best practice)
envSecrets:
  authOidcCredentials:
    existingSecret: "auth-oidc-secret"
    oidcClientId: "oidc-client-id"
    oidcClientSecret: "oidc-client-secret"

service:
  enabled: true
  type: ClusterIP
  ports:
    app:
      port: 7575
      targetPort: http
      protocol: TCP

# Health checks
livenessProbe:
  failureThreshold: 3
  initialDelaySeconds: 10
  httpGet:
    path: /api/health/live
    port: 7575

readinessProbe:
  failureThreshold: 3
  initialDelaySeconds: 10
  httpGet:
    path: /api/health/ready
    port: 7575

# Ingress configuration
ingress:
  enabled: false
  ingressClassName: ""
  hosts:
    - host: chart-example.local
      paths:
        - path: /

# Persistence configuration
persistence:
  homarrDatabase:
    enabled: false
    name: "homarr-database"
    storageClassName: "local-path"
    accessMode: "ReadWriteOnce"
    size: "50Mi"
    mountPath: "/appdata"

# Resource limits
resources: {}
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

# Autoscaling
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80

# Scheduling
nodeSelector: {}
tolerations: []
affinity: {}
```

---

## ðŸ”„ Typical Helm Workflow

### 1. Find and Add Chart Repository
```bash
# Search for chart
helm search hub mealie

# Add repository
helm repo add myrepo https://charts.example.com
helm repo update
```

### 2. Inspect Chart Values
```bash
# View all configurable values
helm show values myrepo/mychart > default-values.yaml

# Review what can be customized
cat default-values.yaml
```

### 3. Create Custom Values
```bash
# Create minimal overrides file
cat > my-values.yaml << EOF
replicaCount: 2
service:
  type: LoadBalancer
persistence:
  enabled: true
EOF
```

### 4. Install with Custom Values
```bash
helm install myapp myrepo/mychart \
  --namespace myapp \
  --create-namespace \
  --values my-values.yaml
```

### 5. Verify Installation
```bash
# Check release status
helm status myapp -n myapp

# Check created resources
kubectl get all -n myapp
```

### 6. Update When Needed
```bash
# Modify values file
vim my-values.yaml

# Apply updates
helm upgrade myapp myrepo/mychart -n myapp --values my-values.yaml
```

---

## ðŸ“‹ Quick Commands Reference

```bash
# Repository
helm repo add <name> <url>      # Add repo
helm repo update                # Update repos
helm repo list                  # List repos
helm search repo <keyword>      # Search charts

# Install/Upgrade
helm install <release> <chart>              # Install
helm install <release> <chart> -n <ns> --create-namespace
helm install <release> <chart> -f values.yaml
helm upgrade <release> <chart> -f values.yaml
helm upgrade --install <release> <chart>    # Install or upgrade

# Manage
helm ls -A                      # List all releases
helm status <release> -n <ns>   # Release status
helm history <release> -n <ns>  # Release history
helm rollback <release> -n <ns> # Rollback
helm uninstall <release> -n <ns> # Uninstall

# Inspect
helm show values <chart>        # Show default values
helm show chart <chart>         # Show chart info
helm template <release> <chart> # Render templates

# Debug
helm install --dry-run --debug <release> <chart>
helm lint <chart-directory>     # Validate chart
```

---

## ðŸŽ¯ Best Practices

### Chart Development
- **Always use `helm lint`** - Validate charts before deploying
- **Use semantic versioning** - For both chart and app versions
- **Document values** - Comment every configurable value
- **Provide sensible defaults** - Charts should work out of the box
- **Use templates wisely** - Don't over-engineer

### Production Deployments
- **Version pin everything** - Chart versions and image tags
- **Use values files** - Not --set for complex configs
- **Store values in git** - Version control your configurations
- **Use namespaces** - Isolate releases properly
- **Test with --dry-run** - Validate before applying

### Security
- **Use secrets properly** - Reference existing secrets, don't embed
- **Limit RBAC** - Only grant necessary permissions
- **Scan charts** - Use tools like Trivy for vulnerability scanning
- **Review values** - Especially for third-party charts

---

## ðŸ”— Related Topics
- [[Kubernetes Deployments]]
- [[Kubernetes Services]]
- [[Kubernetes ConfigMaps and Secrets]]
- [[Kubernetes Persistent Storage]]
- [[Kubernetes Ingress]]
- [[GitOps with Helm]]