## Core Concepts

### Cluster, User, and Context

- **Cluster**: The Kubernetes cluster infrastructure (e.g., Rancher Desktop)
- **User**: Authentication credentials for accessing the cluster
- **Context**: Combination of cluster + user + namespace configuration
  - Allows you to switch between different clusters/users quickly
  - Each context can have a default namespace

### kubectl Config Commands

```bash
# List all user@cluster configurations
kubectl config get-contexts

# Select a specific user@cluster configuration
kubectl config use-context user@cluster

# Display current user@cluster configuration
kubectl config current-context

# View full config file
kubectl config view
```

### Namespace

**Namespaces** provide logical separation within a cluster:
- **Purpose**: Organize resources, apply quotas, and provide isolation
- **Default namespaces**:
  - `default` - where resources are created if no namespace is specified
  - `kube-system` - for Kubernetes system components
  - `kube-public` - publicly readable by all users
  - `kube-node-lease` - for node heartbeat data

```bash
# List all namespaces
kubectl get namespaces
# or
kubectl get ns

# Create a pod in a specific namespace
k run nginx --image=nginx -n my-namespace

# Set default namespace for current context
kubectl config set-context --current --namespace=my-namespace

# View resources in all namespaces
kubectl get pods --all-namespaces
# or
kubectl get pods -A
```

---

## Working with kubectl Documentation

```bash
# Easy way to read command documentation
k run -h | less

# Get explain documentation for resources
kubectl explain pod
kubectl explain pod.spec
kubectl explain pod.spec.containers
```

---

## Pods

### Creating Pods

```bash
k run httpd-zhivko --image=httpd
k run nginx-zhivko --image=nginx

# Run pod with dry-run to see YAML
k run nginx --image=nginx --dry-run=client -o yaml

# Run pod with specific command
k run busybox --image=busybox -- sleep 3600

# Run pod and expose port
k run nginx --image=nginx --port=80
```

### What are Pods?

**A Pod is the smallest deployable unit in Kubernetes**

- The name "pod" comes from "a pod of whales" 🐋
- **A Pod is NOT a container!**
- A pod is a wrapper around one or more containers + shared resources
- Pods are **ephemeral** - they can be destroyed and recreated
- Each pod gets a **unique IP address** in the cluster

### Pod Components

**Container Types:**
- **Single container** - Most common pattern (one app per pod)
- **Multi-container** - Containers that need to work closely together
  - Share the same network namespace (localhost communication)
  - Share the same storage volumes
  - Always scheduled on the same node
  - Common patterns: sidecar, ambassador, adapter
- **Init containers** - Run before main containers start
  - Must complete successfully before app containers start
  - Run sequentially (one after another)
  - Use cases: setup scripts, waiting for dependencies, security/compliance checks

**Shared Resources:**
- **Networking** - All containers in a pod share the same IP and port space
- **Storage** - Volumes can be shared between containers in the pod

### Pod Lifecycle States

```bash
# View pod status
k get pods
```

**Common Pod States:**
- `Pending` - Pod accepted but not yet scheduled or container images being pulled
- `Running` - Pod bound to node, all containers created, at least one running
- `Succeeded` - All containers terminated successfully (exit 0)
- `Failed` - All containers terminated, at least one failed (non-zero exit)
- `Unknown` - Pod state cannot be determined
- `CrashLoopBackOff` - Container keeps crashing, Kubernetes backing off restart attempts

### Pod Information Commands

```bash
# Get full information about a pod
k describe pod nginx-zhivko

# Show pods with IP addresses and nodes
k get pods -o wide

# Get pod in YAML format
k get pod nginx-zhivko -o yaml

# Get pod in JSON format
k get pod nginx-zhivko -o json

# Watch pods in real-time
k get pods -w

# Get pod logs
k logs nginx-zhivko

# Get logs from specific container in multi-container pod
k logs nginx-zhivko -c container-name

# Follow logs (like tail -f)
k logs -f nginx-zhivko
```

> **Note**: Even if we don't assign an IP to the pod, Kubernetes automatically assigns an IP address from the pod network CIDR

### Deleting Pods

```bash
# Delete a pod
k delete pod nginx-zhivko

# Delete pod immediately (no grace period)
k delete pod nginx-zhivko --force --grace-period=0

# Delete all pods in current namespace
k delete pods --all
```

---

## Pod Architecture Flow

### What happens when you run `k run nginx --image=nginx`?

1. **kubectl** reads `~/.kube/config` to find API server location and credentials
2. **kubectl** sends HTTP POST request to API server (port 6443)
3. **API Server** authenticates and authorizes the request
4. **API Server** validates the pod specification
5. **API Server** writes pod definition to **etcd** (state: Pending)
6. **Scheduler** watches for unscheduled pods
7. **Scheduler** selects best node based on:
   - Resource requirements (CPU, memory)
   - Node availability
   - Affinity/anti-affinity rules
   - Taints and tolerations
8. **Scheduler** updates pod definition with node assignment
9. **kubelet** on the selected node watches for pods assigned to it
10. **kubelet** pulls container image (if not cached)
11. **kubelet** instructs container runtime (containerd/Docker) to create container
12. **kubelet** reports pod status back to API server
13. **API Server** updates etcd with pod status (state: Running)

### How does kubectl know to contact the API Server?

When running a command from Mac with Rancher Desktop, kubectl uses the config file located at `~/.kube/config`

#### kubeconfig File Structure

```yaml
apiVersion: v1
kind: Config

clusters:
  - name: rancher-desktop
    cluster:
      server: https://127.0.0.1:6443  # API Server endpoint
      certificate-authority-data: ...  # CA cert for TLS verification
      insecure-skip-tls-verify: false

users:
  - name: rancher-desktop
    user:
      client-certificate-data: ...  # Client cert for authentication
      client-key-data: ...          # Client private key

contexts:
  - name: rancher-desktop
    context:
      cluster: rancher-desktop      # Which cluster to use
      user: rancher-desktop          # Which user credentials to use
      namespace: default             # Default namespace (optional)

preferences: {}
current-context: rancher-desktop    # Active context
```

**Key Components:**
- **server**: Exact location of the API server (`https://127.0.0.1:6443`)
- **certificate-authority-data**: CA certificate to verify API server identity
- **client-certificate-data**: Your client certificate for authentication
- **client-key-data**: Your private key for authentication
- **current-context**: Which context is currently active

---

## Control Plane Components

The **Control Plane** manages the cluster:

- **API Server** - Front-end for Kubernetes control plane, handles all REST requests
- **etcd** - Distributed key-value store, holds all cluster state data
- **Scheduler** - Assigns pods to nodes based on resource requirements
- **Controller Manager** - Runs controller processes (node, replication, endpoints, service accounts)
- **Cloud Controller Manager** - Interacts with cloud provider APIs (if applicable)

---

## Pod Networking

### How Pods Communicate

- **Pod-to-Pod**: Each pod gets its own IP, pods can talk directly using IPs
- **Within Pod**: Containers share `localhost`, communicate via `127.0.0.1`
- **Pod CIDR**: Range of IPs assigned to pods (e.g., `10.42.0.0/16`)
- **DNS**: Kubernetes provides internal DNS for service discovery

```bash
# Access another container in the same pod
curl localhost:8080

# Access another pod (if you know its IP)
curl 10.42.0.45

# Access via service name (DNS)
curl my-service.my-namespace.svc.cluster.local
```

---

## Init Container Example

A pod with an init container that checks if PostgreSQL is ready:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
spec:
  initContainers:
  - name: init-db-check
    image: busybox
    command: ['sh', '-c', 'until nslookup postgres-service; do echo waiting for db; sleep 2; done']
  containers:
  - name: myapp
    image: myapp:latest
```

**Use cases:**
- Wait for dependencies (databases, services)
- Populate shared volumes with data
- Security checks or compliance validation
- Clone git repositories
- Register pod with external systems

**Behavior:**
- If init container fails, entire pod fails
- Init containers run **sequentially** in order defined
- Must complete successfully before app containers start

---

## Architecture Diagram Summary

```
User (Mac with Rancher Desktop)
    ↓
kubectl command (k run nginx --image=nginx)
    ↓
~/.kube/config (contains API server location + auth)
    ↓
Port 6443 (HTTPS - API Server)
    ↓
┌─────────────────────────────────────────┐
│         Kubernetes Cluster              │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │      Control Plane               │  │
│  │  ┌──────────┐  ┌──────────┐     │  │
│  │  │Scheduler │  │API Server│     │  │
│  │  └──────────┘  └──────────┘     │  │
│  │       ┌──────────┐               │  │
│  │       │   etcd   │               │  │
│  │       └──────────┘               │  │
│  └──────────────────────────────────┘  │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │       Worker Nodes               │  │
│  │  ┌─────────┐  ┌─────────┐       │  │
│  │  │ NODE 1  │  │ NODE 2  │       │  │
│  │  │┌───────┐│  │┌───────┐│       │  │
│  │  ││ pod   ││  ││ pod   ││       │  │
│  │  ││ pod   ││  ││ pod   ││       │  │
│  │  │└───────┘│  │└───────┘│       │  │
│  │  │kubelet  │  │kubelet  │       │  │
│  │  └─────────┘  └─────────┘       │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

---

## Key Takeaways

1. **Pod Definition**: A pod wraps containers + shared networking and storage resources
2. **Ephemeral Nature**: Pods are temporary and can be replaced at any time
3. **Automatic IP Assignment**: Every pod receives a unique IP from the pod network
4. **kubectl Config**: `~/.kube/config` defines cluster endpoint, authentication, and context
5. **API Server**: All kubectl commands go through the API server (port 6443 with TLS)
6. **Scheduling**: The scheduler decides which node runs each pod
7. **kubelet**: Agent on each node that manages pods and containers
8. **etcd**: Single source of truth for all cluster state
9. **Namespaces**: Logical isolation within the cluster
10. **Init Containers**: Run before app containers, useful for setup and dependencies

---

## Common kubectl Aliases

```bash
# Add to ~/.bashrc or ~/.zshrc
alias k='kubectl'
alias kgp='kubectl get pods'
alias kgpo='kubectl get pods -o wide'
alias kdp='kubectl describe pod'
alias kgn='kubectl get nodes'
alias kga='kubectl get all'
alias kgaa='kubectl get all --all-namespaces'
```
